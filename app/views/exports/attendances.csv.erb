<% days = @attendances.group_by{|a| a.date}.keys.sort %>
<%- header_row = ['Name'].concat days -%>
<%= CSV.generate_line(header_row, {:row_sep => ''}) %>
<%- sorted_students = @students.sort_by{|s| s["sortable_name"]} -%>
<%-  sorted_students.each do |student|
  if student["name"].include?(',')
    parts = student["name"].split(',')
    parts = parts.map { |p| p.strip }
    last = parts.shift
    row = [parts.join(' ') << ' ' << last]
  else
    row = [student["name"]]
  end

  days.each do |day|
    att = @attendances.find { |att| att.date == day && student["id"] == att.lms_student_id }
    if !att.nil? && !att.status.empty?
      row << att.status.downcase
    else
      row << "n/a"
    end
  end %>
  <%= CSV.generate_line(row, {:row_sep => ''}) %>
<%- end %>
